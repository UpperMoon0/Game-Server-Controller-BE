name: Deploy to VPS

on:
  workflow_run:
    workflows: ["Build, Test, and Push Docker Image"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Run if: build succeeded OR manually triggered
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Fetch Secrets from Key Vault
      id: kv
      run: |
        VPS_HOST=$(az keyvault secret show --vault-name nstutcommonkv --name vps-host --query value -o tsv)
        VPS_USER=$(az keyvault secret show --vault-name nstutcommonkv --name vps-username --query value -o tsv)
        VPS_PASS=$(az keyvault secret show --vault-name nstutcommonkv --name vps-password --query value -o tsv)
        
        DB_URL=$(az keyvault secret show --vault-name nstutcommonkv --name db-url --query value -o tsv)
        DB_USERNAME=$(az keyvault secret show --vault-name nstutcommonkv --name db-username --query value -o tsv)
        DB_PASSWORD=$(az keyvault secret show --vault-name nstutcommonkv --name db-password --query value -o tsv)

        echo "::add-mask::$VPS_HOST"
        echo "::add-mask::$VPS_USER"
        echo "::add-mask::$VPS_PASS"
        echo "::add-mask::$DB_PASSWORD"

        echo "VPS_HOST=$VPS_HOST" >> $GITHUB_OUTPUT
        echo "VPS_USERNAME=$VPS_USER" >> $GITHUB_OUTPUT
        echo "VPS_PASSWORD=$VPS_PASS" >> $GITHUB_OUTPUT
        
        echo "DB_URL=$DB_URL" >> $GITHUB_OUTPUT
        echo "DB_USERNAME=$DB_USERNAME" >> $GITHUB_OUTPUT
        echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_OUTPUT

    - name: Copy docker-compose.yaml to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ steps.kv.outputs.VPS_HOST }}
        username: ${{ steps.kv.outputs.VPS_USERNAME }}
        password: ${{ steps.kv.outputs.VPS_PASSWORD }}
        port: 22
        timeout: 120s
        source: "docker-compose.yaml"
        target: "/root/game-server-controller-be"
        overwrite: true

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      env:
        DB_URL: ${{ steps.kv.outputs.DB_URL }}
        DB_USERNAME: ${{ steps.kv.outputs.DB_USERNAME }}
        DB_PASSWORD: ${{ steps.kv.outputs.DB_PASSWORD }}
      with:
        host: ${{ steps.kv.outputs.VPS_HOST }}
        username: ${{ steps.kv.outputs.VPS_USERNAME }}
        password: ${{ steps.kv.outputs.VPS_PASSWORD }}
        port: 22
        timeout: 120s
        envs: DB_URL,DB_USERNAME,DB_PASSWORD
        script: |
          mkdir -p /root/game-server-controller-be
          cd /root/game-server-controller-be

          # Parse DATABASE_URL to extract components
          # Expected format: postgresql://user:password@host:port/database
          DB_HOST=$(echo "${DB_URL}" | sed -n 's/.*@\([^:]*\):.*/\1/p')
          DB_PORT=$(echo "${DB_URL}" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
          DB_NAME=$(echo "${DB_URL}" | sed -n 's/.*\/\([^?]*\)$/\1/p')

          # Create .env file from secrets
          echo "ENVIRONMENT=production" > .env
          echo "DATABASE_HOST=${DB_HOST}" >> .env
          echo "DATABASE_PORT=${DB_PORT}" >> .env
          echo "DATABASE_NAME=${DB_NAME}" >> .env
          echo "DATABASE_USER=${DB_USERNAME}" >> .env
          echo "DATABASE_PASSWORD=${DB_PASSWORD}" >> .env

          # Stop existing containers to free up ports
          docker compose down || true

          docker pull nstut/game-server-controller-be:${{ github.event.inputs.image_tag || 'latest' }}
          docker compose -f docker-compose.yaml up -d --remove-orphans
